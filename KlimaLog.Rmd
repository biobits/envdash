---
title: "Klimalog Schumacherstr. 49 3. OG"
output:
  html_document:
    toc: true
    theme: united
---



```{r  start, echo=FALSE,warning=FALSE,error=FALSE,comment=NA,results='hide',message=FALSE}
library(ggplot2)
library(dplyr)
library(scales)
library("sqldf")
library(ggthemes)
library(RPostgreSQL)
source("temp_func.R")
library(grid)
library(gridExtra)



query<-paste("select m.*,l.location from messwerte as m inner join locations l on m.locationid=l.idlocation ")
data<-sqldf(query)
data<-data%>%mutate(date2=as.POSIXct(strptime(timestamp,"%Y-%m-%d %H:%M:%S")), tag=as.POSIXct(strptime(timestamp,"%Y-%m-%d")),col_temp=ifelse(temp<20,"palegreen3",ifelse(temp<=26,"goldenrod1","tomato1")))%>%arrange((date2))

ddtemp<-data%>%group_by(tag,location,locationid)%>%summarize(mt=mean(temp,na.rm = TRUE))

mittemp<-read.csv("MittTemp.csv",header=TRUE,sep=";")
mitt<-mittemp%>%mutate(Datum=as.POSIXct(strptime(Datum2,"%Y-%m-%d")))  

mitt<-getHamData()

exempday<-"2015-06-30"
edd<-format(as.POSIXct(exempday), "%d.%m.%Y")

#opts_chunk$set(fig.pos='H',dev=c('pdf','png'),comment = NA,echo=FALSE, warning=FALSE,message=FALSE) 
#opts_knit$set(progress = F, verbose = F,echo=FALSE, warning=FALSE,message=FALSE,unnamed.chunk.label="analysis",comment = NA)

```

# Übersicht
   
Zeitraum der Messung `r format(as.POSIXct(min(data$timestamp)), "%d.%m.%Y")` - `r format(as.POSIXct(max(data$timestamp)), "%d.%m.%Y")`.   
Anzahl der Messsensoren: 3.   
Anzahl der bisher erfassten Temperaturdatenpunkte: `r length(data$timestamp)`.   
   
Exemplarische Tagesdaten werden dargestellt für den `r edd`.
  

```{r c1, echo=FALSE,warning=FALSE,comment=NA,eval=FALSE}
dbreak<-"2 weeks"
    ggplot(data,aes(date2,temp,color=col_temp))+geom_point(aes(col=location))+
   theme_minimal(base_size = 12, base_family = "Helvetica") + theme(axis.title = element_text(vjust=0.1),axis.title.y=element_text(vjust=0.5))+
      scale_x_datetime(breaks = date_breaks(dbreak))#+
     # scale_colour_identity("temp", breaks=data$col_temp)

```
   
## Vollständige Temperaturkurve aller Messpunkte

```{r c2, echo=FALSE,warning=FALSE,comment=NA}
dbreak<-"2 weeks"
    ggplot(data,aes(date2,temp))+geom_line(aes(col=location))+
  theme_minimal(base_size = 12, base_family = "Helvetica") + theme(axis.title = element_text(vjust=0.1),axis.title.y=element_text(vjust=0.5))+
   theme(legend.position="bottom",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(x = "Datum",y="Temperatur °C")+
      scale_x_datetime(breaks = date_breaks(dbreak))
    

```

## Verlauf der offiziellen mittleren Aussentemperatur / Tag

```{r c3, echo=FALSE,warning=FALSE,comment=NA}
dbreak<-"2 weeks"
  q1<-  ggplot(mitt,aes(Datum,LUFTTEMPERATUR))+geom_line()+labs(y="mitt. Lufttemp.")+
   theme_minimal(base_size = 12, base_family = "Helvetica")+
    #  scale_x_datetime(breaks = date_breaks(dbreak)) + 
    theme(axis.title.x = element_blank(),axis.title.y=element_text(vjust=0.5),legend.position="bottom",
          axis.text.x=element_blank(),axis.ticks.x=element_blank())
   q2<-  ggplot(mitt,aes(Datum,SONNENSCHEINDAUER))+geom_bar(aes(col="green"),stat = "identity",)+
   theme_minimal(base_size = 12, base_family = "Helevetica") + theme(axis.title = element_text(vjust=0.1),axis.title.y=element_text(vjust=0.5))+
      scale_x_datetime(breaks = date_breaks(dbreak))+
   theme(legend.position="none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
grid.arrange(q1, q2)

```

## Exemplarischer Temperaturverlauf Schlafzimmer [`r edd`]

```{r IMGaTempDay,echo=FALSE,warning=FALSE,comment=NA}

zdat<-data%>%filter(locationid==1,tag==exempday)


ggplot(zdat,aes(date2,temp,color="darkred"),alpha=0.9)+geom_line()+
  theme_minimal(base_size = 12, base_family = "Helvetica") + theme(axis.title = element_text(vjust=0.1),axis.title.y=element_text(vjust=0.5))+
 scale_x_datetime(breaks = date_breaks("1 hour"))+
  labs(x = "Tageszeit",y="Temperatur °C")+ 
  theme(legend.position="none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


## Anteil Zimmertemperatur (Schlafzimmer) über 26°C Monat Juni

```{r anteil,echo=FALSE,warning=FALSE,comment=NA}
testdat<-data%>%mutate(tag=as.Date(timestamp, format = '%d.%m.%Y',tz=""),monat=format(timestamp, "%m"),ishot=ifelse(temp>26.0,TRUE,FALSE),
               zeit=strftime(timestamp, format = '%H:%M:%S'))%>%
  group_by(monat,tag,locationid,ishot)%>%summarise(mintime=min(timestamp)
                                             ,maxtime=max(timestamp)
                                             ,diff=difftime(max(timestamp),min(timestamp), 
                                                       units = "min")
                                             ,ant=round((100/1440)*difftime(max(timestamp),min(timestamp), 
                                                                units = "min"),2)
                                             )%>%mutate(Anteil=ifelse(ishot==TRUE,ant,0))%>%
          select(monat,tag,locationid,Anteil)


```

```{r IMGanteil,echo=FALSE,warning=FALSE,comment=NA}

dat<-testdat%>%filter(locationid==1,monat=="06")


ggplot(dat,aes(x=as.POSIXct(tag),y=Anteil,fill=ifelse(dat$Anteil>10,"darkred","darkgreen"),alpha=0.9))+
  theme_minimal(base_size = 12, base_family = "Helvetica") + theme(axis.title = element_text(vjust=0.1),axis.title.y=element_text(vjust=0.5))+
  geom_bar(stat = "identity")+scale_x_datetime(breaks = date_breaks("day"))+
  scale_fill_identity("Anteil", breaks=ifelse(dat$Anteil>10,"darkred","darkgreen"))+labs(x = "Datum",y="Anteil [%] t > 26°C")+ 
  theme(legend.position="none",axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

